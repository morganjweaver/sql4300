//
// Created by Kevin Lundeen on 4/6/17.
//

#include "SQLExec.h"

std::ostream &operator<<(std::ostream &out, const QueryResult &qres) {
    if (qres.column_names != nullptr) {
        for (auto const &column_name: *qres.column_names)
            out << column_name << " ";
        out << std::endl << "+";
        for (int i = 0; i < qres.column_names->size(); i++)
            out << "------------+";
        out << std::endl;
        for (auto const &row: *qres.rows) {
            for (auto const &column_name: *qres.column_names) {
                Value value = row->at(column_name);
                switch (value.data_type) {
                    case ColumnAttribute::INT:
                        out << value.n;
                        break;
                    case ColumnAttribute::TEXT:
                        out << "\"" << value.s << "\"";
                        break;
                    default:
                        out << "???";
                }
                out << " ";
            }
            out << std::endl;
        }
    }
    out << qres.message;
    return out;
}

QueryResult::~QueryResult() { /* FIXME */ }

QueryResult *SQLExec::execute(const hsql::SQLStatement *statement) throw(SQLExecError) {
    try {
        switch (statement->type()) {
            case hsql::kStmtCreate:
                return create((const hsql::CreateStatement *) statement);
            case hsql::kStmtDrop:
                return drop((const hsql::DropStatement *) statement);
            case hsql::kStmtShow:
                return show((const hsql::ShowStatement *) statement);
            default:
                return new QueryResult("not implemented");
        }
    } catch (DbRelationError& e) {
        throw SQLExecError(std::string("DbRelationError: ") + e.what());
    }
}

QueryResult *SQLExec::create(const hsql::CreateStatement *statement) {
    return new QueryResult("execute create not implemented");
}

QueryResult *SQLExec::drop(const hsql::DropStatement *statement) {
    return new QueryResult("execute drop not implemented");
}

QueryResult *SQLExec::show(const hsql::ShowStatement *statement)  {
    return new QueryResult("execute show not implemented");
}
